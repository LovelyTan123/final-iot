<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üåø Hydroponics Monitoring Dashboard</title>

  <!-- Bootstrap & Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

  <!-- Google Font for cute look -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      background: #fef6fb;
      color: #333;
      font-family: 'Poppins', sans-serif;
    }

    .navbar {
      background: linear-gradient(to right, #a1c4fd, #c2e9fb);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .navbar-brand {
      font-weight: bold;
      color: #080101 !important;
      font-size: 1.5rem;
    }

    .nav-link {
      color: #fff !important;
      font-weight: 500;
    }

    .nav-link:hover {
      opacity: 0.9;
    }

    .card {
      background-color: #ffffff;
      border: none;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .sensor-value {
      font-size: 1.6rem;
      font-weight: bold;
    }

    .sensor-label {
      font-size: 1rem;
      color: #888;
    }

    .section-header {
      border-bottom: 2px dashed #f8bbd0;
      padding-bottom: 10px;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      font-size: 1.4rem;
      color: #d63384;
    }

    canvas {
      background: #fff;
      padding: 15px;
      border-radius: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }

    .nav-tabs .nav-link {
      border: none;
      background: #e0f7fa;
      margin-right: 5px;
      border-radius: 15px;
      color: #00796b;
      font-weight: 500;
    }

    .nav-tabs .nav-link.active {
      background: #4dd0e1;
      color: #fff;
    }

    #about-section {
      background-color: #fff;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-top: 30px;
      display: none;
    }

    #about-section img {
      object-fit: cover;
      border: 3px solid #c2e9fb;
    }

    .motion-detected { color: #66bb6a; }
    .motion-not-detected { color: #ef5350; }
    .light-active { color: #ffd54f; }
    .light-inactive { color: #b0bec5; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="fas fa-seedling me-2"></i>üå± Hydro Dashboard</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link active dashboard-link" href="#dashboard">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link about-link" href="#about">About Us</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Dashboard Section -->
  <div class="container mt-4" id="dashboard">
    <div class="section-header">Latest Sensor Readings</div>
    <div class="row text-center g-4">
      <div class="col-md-2 col-6">
        <div class="card p-3">
          <div class="sensor-label">üåû Light</div>
          <div id="light" class="sensor-value">Loading...</div>
        </div>
      </div>
      <div class="col-md-2 col-6">
        <div class="card p-3">
          <div class="sensor-label">üîÜ Light Intensity</div>
          <div id="lightIntensity" class="sensor-value">Loading...</div>
        </div>
      </div>
      <div class="col-md-2 col-6">
        <div class="card p-3">
          <div class="sensor-label">üö∂ Motion</div>
          <div id="motion" class="sensor-value">Loading...</div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="card p-3">
          <div class="sensor-label">üå°Ô∏è Temperature (¬∞C)</div>
          <div id="temperature" class="sensor-value">Loading...</div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="card p-3">
          <div class="sensor-label">üíß Humidity (%)</div>
          <div id="humidity" class="sensor-value">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart Section -->
  <div class="container mt-5">
    <div class="section-header">üìä Sensor Data History</div>
    <ul class="nav nav-tabs">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#lightTab">Light</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#motionTab">Motion</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tempTab">Temp & Humidity</button></li>
    </ul>
    <div class="tab-content text-center">
      <div class="tab-pane fade show active" id="lightTab"><canvas id="lightChart"></canvas></div>
      <div class="tab-pane fade" id="motionTab">
        <canvas id="motionChart"></canvas>
        <div class="mt-4">
          <h5 class="mb-3">Motion Detection History</h5>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="motionTableBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="tempTab"><canvas id="tempHumChart"></canvas></div>
    </div>
  </div>

  <!-- About Section -->
  <div class="container" id="about-section">
    <div class="section-header">üìò About Us</div>
    <div class="text-center mb-4 d-flex justify-content-center gap-4 flex-wrap">
      <div>
        <img src="image/santos.jpg" alt="Santos" class="rounded-circle mb-2" width="120" height="120">
        <div><strong>Victor Santos</strong></div>
      </div>
      <div>
        <img src="image/tan.jpg" alt="Tan" class="rounded-circle mb-2" width="120" height="120">
        <div><strong>Lovely Tan</strong></div>
      </div>
      <div>
        <img src="image/isidro.jpg" alt="Isidro" class="rounded-circle mb-2" width="120" height="120">
        <div><strong>Azhly Isidro</strong></div>
      </div>
    </div>
    <p class="lead">
      Welcome to our Hydroponics Monitoring Dashboard! This little system is here to help us keep track of our garden's light, motion, temperature, and humidity with a sprinkle of love and data. 
    </p>
    <p>
      Our mission? Helping plants grow healthy and strong while making our dashboard look fabulous! ü™¥
    </p>
  </div>

 <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Update the database URL to your actual Firebase Realtime Database URL
    const dbUrl = "https://iotfinal-73d37-default-rtdb.asia-southeast1.firebasedatabase.app/sensorData.json";

    const lightEl = document.getElementById("light");
    const motionEl = document.getElementById("motion");
    const tempEl = document.getElementById("temperature");
    const humEl = document.getElementById("humidity");
    const lightIntensityEl = document.getElementById("lightIntensity");

    function processSensorValue(value, type) {
      if (value === null || value === undefined) return null;
      switch (type) {
        case 'light':
          return String(value).toUpperCase() === 'ACTIVE' ? 'ACTIVE' : 'INACTIVE';
        case 'motion':
          return String(value).toUpperCase().includes('DETECTED') ? 'DETECTED' : 'NOT DETECTED';
        case 'temperature':
        case 'humidity':
          return isNaN(value) ? null : parseFloat(value).toFixed(1);
        case 'lightIntensity':
          return isNaN(value) ? null : parseInt(value);
        default:
          return value;
      }
    }

    function formatTime(ts) {
      const timestamp = isNaN(ts) ? new Date(ts) : new Date(Number(ts));
      return timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(ts) {
      const timestamp = isNaN(ts) ? new Date(ts) : new Date(Number(ts));
      return timestamp.toLocaleDateString();
    }

    async function fetchSensorData() {
      try {
        // Fetch data from Firebase with timestamp to prevent caching
        const res = await fetch(`${dbUrl}?time=${Date.now()}`);
        const data = await res.json();

        if (!data) {
          console.error("No data received from database");
          return;
        }

        // Process and sort the data
        const entries = Object.entries(data).map(([key, val]) => ({
          key,
          timestamp: val.timestamp || key,
          light: val.light,
          motion: val.motion,
          temperature: parseFloat(val.temperature),
          humidity: parseFloat(val.humidity),
          lightIntensity: parseInt(val.lightIntensity)
        })).sort((a, b) => Number(a.timestamp) - Number(b.timestamp));

        if (entries.length === 0) {
          console.error("No entries found in the data");
          return;
        }

        const latest = entries[entries.length - 1];

        // Display current sensor readings
        const lightStatus = processSensorValue(latest.light, 'light');
        const motionStatus = processSensorValue(latest.motion, 'motion');
        const tempVal = processSensorValue(latest.temperature, 'temperature');
        const humVal = processSensorValue(latest.humidity, 'humidity');
        const lightIntensityVal = processSensorValue(latest.lightIntensity, 'lightIntensity');

        // Update the display elements
        lightEl.textContent = lightStatus;
        lightEl.className = `sensor-value ${lightStatus === 'ACTIVE' ? 'light-active' : 'light-inactive'}`;

        motionEl.textContent = motionStatus;
        motionEl.className = `sensor-value ${motionStatus === 'DETECTED' ? 'motion-detected' : 'motion-not-detected'}`;

        tempEl.textContent = tempVal !== null ? `${tempVal} ¬∞C` : 'N/A';
        humEl.textContent = humVal !== null ? `${humVal} %` : 'N/A';
        lightIntensityEl.textContent = lightIntensityVal !== null ? `${lightIntensityVal}` : 'N/A';

        // Update motion table with all historical data
        const motionTableBody = document.getElementById('motionTableBody');
        motionTableBody.innerHTML = entries.map(entry => `
          <tr>
            <td>${formatTime(entry.timestamp)}</td>
            <td>${formatDate(entry.timestamp)}</td>
            <td class="${entry.motion.toUpperCase().includes('DETECTED') ? 'text-success' : 'text-danger'}">
              ${entry.motion.toUpperCase().includes('DETECTED') ? 'Motion Detected' : 'No Motion'}
            </td>
          </tr>
        `).join('');

        // Update all charts with the complete dataset
        updateCharts(entries);

      } catch (err) {
        console.error("Error fetching sensor data:", err);
        // Display error state in the UI
        lightEl.textContent = 'Error';
        motionEl.textContent = 'Error';
        tempEl.textContent = 'Error';
        humEl.textContent = 'Error';
        lightIntensityEl.textContent = 'Error';
      }
    }

    let lightChart, motionChart, tempHumChart;

    function updateCharts(data) {
      const labels = data.map(d => formatTime(d.timestamp));
      const lightIntensityData = data.map(d => d.lightIntensity);
      const motionData = data.map(d => d.motion.toUpperCase().includes("DETECTED") ? 1 : 0);
      const tempData = data.map(d => d.temperature);
      const humData = data.map(d => d.humidity);

      // Light Chart
      if (!lightChart) {
        const ctx = document.getElementById('lightChart').getContext('2d');
        lightChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Light Intensity',
              data: lightIntensityData,
              borderColor: '#ffd54f',
              backgroundColor: 'rgba(255,213,79,0.2)',
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      } else {
        lightChart.data.labels = labels;
        lightChart.data.datasets[0].data = lightIntensityData;
        lightChart.update();
      }

      // Motion Chart
      if (!motionChart) {
        const ctx = document.getElementById('motionChart').getContext('2d');
        motionChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Motion Detected',
              data: motionData,
              backgroundColor: '#66bb6a'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      } else {
        motionChart.data.labels = labels;
        motionChart.data.datasets[0].data = motionData;
        motionChart.update();
      }

      // Temp & Humidity Chart
      if (!tempHumChart) {
        const ctx = document.getElementById('tempHumChart').getContext('2d');
        tempHumChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'Temperature (¬∞C)',
                data: tempData,
                borderColor: '#ff8a65',
                backgroundColor: 'rgba(255,138,101,0.2)',
                fill: true
              },
              {
                label: 'Humidity (%)',
                data: humData,
                borderColor: '#4fc3f7',
                backgroundColor: 'rgba(79,195,247,0.2)',
                fill: true
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      } else {
        tempHumChart.data.labels = labels;
        tempHumChart.data.datasets[0].data = tempData;
        tempHumChart.data.datasets[1].data = humData;
        tempHumChart.update();
      }
    }

    // Fetch data immediately and then every 5 seconds
    fetchSensorData();
    setInterval(fetchSensorData, 5000);
  </script>
</body>
</html>
