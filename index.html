<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hydroponics Monitoring Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

  <style>
    body {
      background-color: #1e1e2f;
      color: #f5f5f5;
      font-family: 'Segoe UI', sans-serif;
    }

    .navbar {
      background-color: #0d6efd;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .navbar-brand, .nav-link {
      color: #fff !important;
    }

    .nav-link:hover {
      opacity: 0.8;
    }

    .card {
      background-color: #2c2f48;
      border: none;
      color: #ffffff;
      border-radius: 10px;
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .nav-tabs .nav-link.active {
      background-color: #0d6efd;
      color: #fff;
      border-color: #444 #444 #0d6efd;
    }

    .nav-tabs .nav-link {
      color: #ccc;
    }

    .section-header {
      border-bottom: 2px solid #0d6efd;
      padding-bottom: 10px;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
    }

    canvas {
      background-color: #2c2f48;
      padding: 20px;
      border-radius: 10px;
      width: 100% !important;
      height: 400px !important;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #about-section {
      background-color: #2c2f48;
      border-radius: 10px;
      padding: 30px;
      margin-top: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .sensor-value {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .sensor-label {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    .motion-detected {
      color: #4ade80;
    }
    
    .motion-not-detected {
      color: #f87171;
    }
    
    .light-active {
      color: #facc15;
    }
    
    .light-inactive {
      color: #94a3b8;
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="fas fa-leaf me-2"></i>üåø Hydroponics Dashboard</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link active dashboard-link" href="#dashboard">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link about-link" href="#about">About Us</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4" id="dashboard">
    <div class="section-header">
      <h3>üîç Live Sensor Readings</h3>
    </div>
    <div class="row text-center g-4">
      <div class="col-md-2 col-6">
        <div class="card p-3 shadow-sm">
          <div class="sensor-label">Light</div>
          <div id="light" class="sensor-value">Loading...</div>
        </div>
      </div>
      <div class="col-md-2 col-6">
        <div class="card p-3 shadow-sm">
          <div class="sensor-label">Light Intensity</div>
          <div id="lightIntensity" class="sensor-value">Loading...</div>
        </div>
      </div>
      <div class="col-md-2 col-6">
        <div class="card p-3 shadow-sm">
          <div class="sensor-label">Motion</div>
          <div id="motion" class="sensor-value">Loading...</div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="card p-3 shadow-sm">
          <div class="sensor-label">Temperature (¬∞C)</div>
          <div id="temperature" class="sensor-value">Loading...</div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="card p-3 shadow-sm">
          <div class="sensor-label">Humidity (%)</div>
          <div id="humidity" class="sensor-value">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <div class="container mt-5">
    <div class="section-header">
      <h3>üìä Sensor Data History</h3>
    </div>

    <ul class="nav nav-tabs">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#lightTab">Light</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#motionTab">Motion</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tempTab">Temperature & Humidity</button></li>
    </ul>

    <div class="tab-content text-center">
      <div class="tab-pane fade show active" id="lightTab"><canvas id="lightChart"></canvas></div>
      <div class="tab-pane fade" id="motionTab"><canvas id="motionChart"></canvas></div>
      <div class="tab-pane fade" id="tempTab"><canvas id="tempHumChart"></canvas></div>
    </div>
  </div>

  <div class="container" id="about-section">
    <div class="section-header"><h3>About Us</h3></div>
    <p class="lead">
      Welcome to the Hydroponics Monitoring Dashboard. This system is developed to track and analyze real-time sensor data such as light, motion, temperature, and humidity for efficient and smart farming.
    </p>
    <p>
      Our mission is to provide growers with precise environmental monitoring tools to optimize plant growth conditions, reduce resource consumption, and increase yields through data-driven decisions.
    </p>
    <p>
      The system collects data from various sensors and presents it in an intuitive dashboard, allowing you to monitor your hydroponic setup from anywhere at any time.
    </p>
  </div>

  <script>
    const dbUrl = "https://iotfinal-73d37-default-rtdb.asia-southeast1.firebasedatabase.app/sensorData.json";

    const lightEl = document.getElementById("light");
    const motionEl = document.getElementById("motion");
    const tempEl = document.getElementById("temperature");
    const humEl = document.getElementById("humidity");
    const lightIntensityEl = document.getElementById("lightIntensity");
    const aboutSection = document.getElementById("about-section");
    const dashboardLink = document.querySelector(".dashboard-link");
    const aboutLink = document.querySelector(".about-link");

    let lightChart, motionChart, tempHumChart;

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function showDashboard() {
      document.getElementById("dashboard").style.display = "block";
      document.querySelector(".container.mt-5").style.display = "block";
      aboutSection.style.display = "none";
      dashboardLink.classList.add("active");
      aboutLink.classList.remove("active");
    }

    function showAbout() {
      document.getElementById("dashboard").style.display = "none";
      document.querySelector(".container.mt-5").style.display = "none";
      aboutSection.style.display = "block";
      dashboardLink.classList.remove("active");
      aboutLink.classList.add("active");
    }

    dashboardLink.addEventListener("click", (e) => { e.preventDefault(); showDashboard(); });
    aboutLink.addEventListener("click", (e) => { e.preventDefault(); showAbout(); });

    function processSensorValue(value, type) {
      if (value === null || value === undefined) return null;
      
      switch(type) {
        case 'light': 
          return String(value).toUpperCase() === 'ACTIVE' ? 'ACTIVE' : 'INACTIVE';
        case 'motion': 
          return String(value).toLowerCase().includes('detected') ? 'DETECTED' : 'NOT DETECTED';
        case 'temperature': 
          // Convert from raw value to Celsius if needed
          return isNaN(parseFloat(value)) ? null : (parseFloat(value) / 10).toFixed(1);
        case 'humidity': 
          // Convert from raw value to percentage if needed
          return isNaN(parseFloat(value)) ? null : (parseFloat(value) / 100).toFixed(1);
        case 'lightIntensity': 
          return isNaN(parseFloat(value)) ? null : parseFloat(value).toFixed(0);
        default: 
          return value;
      }
    }

    async function fetchSensorData() {
      try {
        const response = await fetch(`${dbUrl}?time=${Date.now()}`);
        const data = await response.json();

        // Convert object to array of entries and sort by timestamp
        const entries = Object.entries(data || {}).map(([key, value]) => {
          return {
            timestamp: value.timestamp || key,
            light: value.light,
            motion: value.motion,
            temperature: value.temperature,
            humidity: value.humidity,
            lightIntensity: value.lightIntensity
          };
        }).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        // Get the latest reading
        const latest = entries[entries.length - 1];
        
        // Update UI with processed values
        const processedLight = processSensorValue(latest.light, 'light');
        lightEl.textContent = processedLight || "N/A";
        lightEl.className = `sensor-value ${processedLight === 'ACTIVE' ? 'light-active' : 'light-inactive'}`;
        
        const processedMotion = processSensorValue(latest.motion, 'motion');
        motionEl.textContent = processedMotion || "N/A";
        motionEl.className = `sensor-value ${processedMotion === 'DETECTED' ? 'motion-detected' : 'motion-not-detected'}`;
        
        const processedTemp = processSensorValue(latest.temperature, 'temperature');
        tempEl.textContent = processedTemp !== null ? `${processedTemp} ¬∞C` : "N/A";
        
        const processedHum = processSensorValue(latest.humidity, 'humidity');
        humEl.textContent = processedHum !== null ? `${processedHum} %` : "N/A";
        
        const processedLightIntensity = processSensorValue(latest.lightIntensity, 'lightIntensity');
        lightIntensityEl.textContent = processedLightIntensity || "N/A";

        // Render charts with the last 10 entries
        renderCharts(entries.slice(-10));
      } catch (err) {
        console.error("Error fetching sensor data:", err);
      }
    }

    function renderCharts(entries) {
      const labels = entries.map(entry => formatTime(entry.timestamp));
      const lightData = entries.map(entry => processSensorValue(entry.light, 'light') === 'ACTIVE' ? 1 : 0);
      const motionData = entries.map(entry => processSensorValue(entry.motion, 'motion') === 'DETECTED' ? 1 : 0);
      const tempData = entries.map(entry => parseFloat(processSensorValue(entry.temperature, 'temperature')));
      const humData = entries.map(entry => parseFloat(processSensorValue(entry.humidity, 'humidity')));
      const lightIntensityData = entries.map(entry => parseFloat(processSensorValue(entry.lightIntensity, 'lightIntensity')));

      // Destroy existing charts if they exist
      if (lightChart) lightChart.destroy();
      if (motionChart) motionChart.destroy();
      if (tempHumChart) tempHumChart.destroy();

      // Light Chart
      lightChart = new Chart(document.getElementById("lightChart"), {
        type: "line",
        data: {
          labels,
          datasets: [
            { 
              label: "Light Status (ACTIVE=1, INACTIVE=0)", 
              data: lightData, 
              borderColor: "#facc15", 
              backgroundColor: "rgba(250, 204, 21, 0.1)",
              borderWidth: 2,
              tension: 0.1,
              fill: true
            },
            { 
              label: "Light Intensity", 
              data: lightIntensityData, 
              borderColor: "#0ea5e9", 
              backgroundColor: "rgba(14, 165, 233, 0.1)",
              borderWidth: 2,
              tension: 0.1,
              fill: true,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              max: 1,
              title: {
                display: true,
                text: 'Light Status'
              }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              title: {
                display: true,
                text: 'Light Intensity'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });

      // Motion Chart
      motionChart = new Chart(document.getElementById("motionChart"), {
        type: "line",
        data: {
          labels,
          datasets: [{ 
            label: "Motion (1 = DETECTED)", 
            data: motionData, 
            borderColor: "#ef4444", 
            backgroundColor: "rgba(239, 68, 68, 0.1)",
            borderWidth: 2,
            tension: 0.1,
            fill: true
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              max: 1,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });

      // Temperature & Humidity Chart
      tempHumChart = new Chart(document.getElementById("tempHumChart"), {
        type: "line",
        data: {
          labels,
          datasets: [
            { 
              label: "Temperature (¬∞C)", 
              data: tempData, 
              borderColor: "#10b981", 
              backgroundColor: "rgba(16, 185, 129, 0.1)",
              borderWidth: 2,
              tension: 0.1,
              fill: true
            },
            { 
              label: "Humidity (%)", 
              data: humData, 
              borderColor: "#8b5cf6", 
              backgroundColor: "rgba(139, 92, 246, 0.1)",
              borderWidth: 2,
              tension: 0.1,
              fill: true,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          scales: {
            y: {
              title: {
                display: true,
                text: 'Temperature (¬∞C)'
              }
            },
            y1: {
              position: 'right',
              title: {
                display: true,
                text: 'Humidity (%)'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
    }

    // Initial fetch and set up periodic updates
    fetchSensorData();
    setInterval(fetchSensorData, 5000);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
